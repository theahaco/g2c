---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="G2C â€” Set Up Passkey">
  <h1>Set Up Your Account</h1>
  <p class="info">
    Register a passkey to secure your smart account, then deploy it on-chain.
    Your passkey (fingerprint, face, or security key) will be the only way to authorize transactions.
  </p>

  <div id="status-bar">
    <div>Account: <code id="contract-id"></code></div>
  </div>

  <div id="error-box" class="error" style="display:none"></div>

  <section>
    <h2>1. Register Passkey</h2>
    <p class="info">
      Your browser will prompt you to create a passkey.
      This passkey is bound to your account and will be used to sign all future transactions.
    </p>
    <div class="field">
      <button id="register-btn">Register Passkey</button>
    </div>
    <pre id="register-result" style="display:none"></pre>
  </section>

  <section id="deploy-section" class="hidden">
    <h2>2. Deploy Account</h2>
    <p class="info">Publish your passkey-secured smart account to the Stellar network.</p>
    <div class="field">
      <button id="deploy-btn" class="primary">Deploy Account</button>
    </div>
    <pre id="deploy-result" style="display:none"></pre>
  </section>

  <section id="done-section" class="hidden">
    <h2>Account Ready</h2>
    <p class="info">Your smart account is live. Use your passkey to sign transactions.</p>
    <div class="field">
      <a id="account-link" class="button-link">Go to Account</a>
    </div>
  </section>
</BaseLayout>

<style>
  body {
    background: #1a1a2e;
  }

  button.primary {
    background: #1a6b3a;
    border-color: #1a8b4a;
    font-size: 1.1rem;
    padding: 0.7rem 2rem;
  }

  button.primary:hover {
    background: #1a8b4a;
  }

  #status-bar {
    background: #0a2040;
    border: 1px solid #1a3060;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    margin: 1rem 0;
    font-size: 0.85rem;
  }

  .button-link {
    display: inline-block;
    background: #1a6b3a;
    color: #e0e0e0;
    border: 1px solid #1a8b4a;
    padding: 0.5rem 1.2rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95rem;
    text-decoration: none;
  }

  .button-link:hover {
    background: #1a8b4a;
  }

  #deploy-result a {
    color: #5bc0de;
    text-decoration: underline;
  }

  #deploy-result a:hover {
    color: #7dd4ed;
  }
</style>

<script>
  import { Keypair, Networks, TransactionBuilder, Operation, Address, Account, rpc, xdr, nativeToScVal } from "@stellar/stellar-sdk";
  import { Buffer } from "buffer";
  import {
    parseRegistration,
    buf2hex,
    buf2base64url,
    contractIdFromHostname,
    saveCredential as sdkSaveCredential,
    activateAccount,
  } from "@g2c/passkey-sdk";

  const FACTORY_CONTRACT_ID = "CDDMELYHOSD6M2T53F5DUYCXDS3VVOQ72E4KZMMZP37GQWII2WRKM2CC";
  const RPC_URL = "https://soroban-testnet.stellar.org";

  // --- State ---

  const hostname = window.location.hostname;
  const contractId = contractIdFromHostname(hostname);
  const rpId = hostname;

  const params = new URLSearchParams(window.location.search);
  const secretKey = params.get("key");

  let passkeyPublicKey: Uint8Array | null = null;
  let credentialIdBytes: Uint8Array | null = null;

  // --- UI refs ---

  const $contractIdEl = document.getElementById("contract-id")!;
  const $errorBox = document.getElementById("error-box")!;
  const $registerBtn = document.getElementById("register-btn") as HTMLButtonElement;
  const $registerResult = document.getElementById("register-result") as HTMLPreElement;
  const $deploySection = document.getElementById("deploy-section")!;
  const $deployBtn = document.getElementById("deploy-btn") as HTMLButtonElement;
  const $deployResult = document.getElementById("deploy-result") as HTMLPreElement;
  const $doneSection = document.getElementById("done-section")!;
  const $accountLink = document.getElementById("account-link") as HTMLAnchorElement;

  // --- UI helpers ---

  function showError(msg: string) {
    $errorBox.textContent = msg;
    $errorBox.style.display = "block";
  }

  function clearError() {
    $errorBox.style.display = "none";
  }

  // --- Init status bar ---

  $contractIdEl.textContent = contractId || "(unknown)";

  if (!contractId) {
    showError("Invalid URL. Please start from the home page.");
  }

  if (!secretKey) {
    showError("Missing setup data. Please start from the home page.");
  }

  // --- Register Passkey ---

  $registerBtn.addEventListener("click", async () => {
    clearError();
    if (!contractId) {
      showError("No contract ID found in subdomain.");
      return;
    }

    try {
      $registerBtn.disabled = true;
      $registerBtn.textContent = "Waiting for authenticator...";

      const userId = new Uint8Array(16);
      crypto.getRandomValues(userId);

      const credential = (await navigator.credentials.create({
        publicKey: {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          rp: { name: `Soroban ${contractId}`, id: rpId },
          user: {
            id: userId,
            name: contractId,
            displayName: `Account ${contractId}`,
          },
          pubKeyCredParams: [{ alg: -7, type: "public-key" }],
          authenticatorSelection: {
            residentKey: "required",
            userVerification: "required",
          },
          attestation: "none",
          timeout: 60000,
        },
      })) as PublicKeyCredential;

      const reg = parseRegistration(credential as any);
      passkeyPublicKey = reg.publicKey;
      credentialIdBytes = reg.credentialId;

      sdkSaveCredential(contractId!, credentialIdBytes, passkeyPublicKey);

      $registerResult.style.display = "block";
      $registerResult.textContent = JSON.stringify(
        {
          credentialId: buf2base64url(credentialIdBytes),
          publicKey: buf2hex(passkeyPublicKey),
          rpId: rpId,
        },
        null,
        2
      );

      $registerBtn.textContent = "Passkey Registered";
      $deploySection.classList.remove("hidden");
    } catch (err: any) {
      if (err.name === "NotAllowedError") {
        showError("Passkey registration was blocked. If you're using an in-app browser (Twitter, Instagram, etc.), tap the menu (\u2026) and choose \"Open in Safari\" or \"Open in Browser\".");
      } else {
        showError(`Registration failed: ${err.message}`);
      }
      $registerBtn.disabled = false;
      $registerBtn.textContent = "Register Passkey";
    }
  });

  // --- Deploy Account ---

  $deployBtn.addEventListener("click", async () => {
    clearError();
    if (!passkeyPublicKey || !secretKey) {
      showError("Register a passkey first and ensure ?key= is set.");
      return;
    }

    try {
      $deployBtn.disabled = true;
      $deployBtn.textContent = "Deploying...";

      const keypair = Keypair.fromSecret(secretKey);
      const server = new rpc.Server(RPC_URL);

      const sourceAccount = await server
        .getAccount(keypair.publicKey())
        .then((res: Account) => new Account(res.accountId(), res.sequenceNumber()));

      const simTxn = new TransactionBuilder(sourceAccount, {
        fee: "100",
        networkPassphrase: Networks.TESTNET,
      })
        .addOperation(
          Operation.invokeContractFunction({
            contract: FACTORY_CONTRACT_ID,
            function: "create_account",
            args: [
              Address.fromString(keypair.publicKey()).toScVal(),
              xdr.ScVal.scvBytes(Buffer.from(passkeyPublicKey)),
              nativeToScVal(1_000_000_0 * 9998, { type: "i128" }),
            ],
          })
        )
        .setTimeout(0)
        .build();

      const sim = await server.simulateTransaction(simTxn);
      if (rpc.Api.isSimulationError(sim) || rpc.Api.isSimulationRestore(sim)) {
        throw new Error(`Simulation failed: ${"error" in sim ? sim.error : "restore needed"}`);
      }

      const transaction = rpc.assembleTransaction(simTxn, sim).setTimeout(0).build();
      transaction.sign(keypair);

      const sendResponse = await server.sendTransaction(transaction);
      if (sendResponse.status === "ERROR") {
        throw new Error(`Transaction submission failed: ${sendResponse.status}`);
      }

      // Poll for completion
      let getResponse = await server.getTransaction(sendResponse.hash);
      while (getResponse.status === "NOT_FOUND") {
        await new Promise((r) => setTimeout(r, 1000));
        getResponse = await server.getTransaction(sendResponse.hash);
      }

      if (getResponse.status !== "SUCCESS") {
        throw new Error(`Transaction failed: ${getResponse.status}`);
      }

      activateAccount(contractId!);

      $deployResult.style.display = "block";
      $deployResult.innerHTML = `Account deployed!\n<a href="https://stellar.expert/explorer/testnet/contract/${contractId}" target="_blank" rel="noopener">View on Stellar Expert</a>`;

      // Show link to account page
      const protocol = window.location.protocol;
      const host = window.location.host;
      $accountLink.href = `${protocol}//${host}/account/`;
      $doneSection.classList.remove("hidden");

      $deployBtn.textContent = "Deployed";
    } catch (err: any) {
      showError(`Deploy failed: ${err.message}`);
      $deployBtn.disabled = false;
      $deployBtn.textContent = "Deploy Account";
    }
  });
</script>

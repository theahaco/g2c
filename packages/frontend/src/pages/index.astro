---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="G2C — Smart Accounts">
  <h1>G2C Smart Accounts</h1>
  <p class="info">
    Create a Stellar smart account secured by your device's passkey (fingerprint, face, or security key).
    No seed phrases or private keys to manage — your passkey <em>is</em> your wallet.
  </p>

  <div id="error-box" class="error" style="display:none"></div>

  <section id="accounts-section" class="hidden">
    <h2>Your Accounts</h2>
    <ul id="accounts-list"></ul>
  </section>

  <section>
    <h2>Create New Account</h2>
    <p class="info">
      Prepares a new smart account on Stellar testnet. You'll register a passkey in the next step to secure it.
    </p>
    <div class="field">
      <button id="create-btn">Create Account</button>
    </div>
    <div id="progress-info" class="progress" style="display:none"></div>
  </section>

  <section id="passkey-section" class="hidden">
    <h2>Set Up Passkey</h2>
    <p class="info">
      Your account address is ready. Continue to register a passkey and activate your account on-chain.
    </p>
    <pre id="c-address-result"></pre>
    <div class="field">
      <a id="setup-link" class="button-link">Register Passkey & Deploy</a>
    </div>
  </section>
</BaseLayout>

<style>
  body {
    background: #1a1a2e;
  }

  .button-link {
    display: inline-block;
    background: #1a6b3a;
    color: #e0e0e0;
    border: 1px solid #1a8b4a;
    padding: 0.5rem 1.2rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95rem;
    text-decoration: none;
  }

  .button-link:hover {
    background: #1a8b4a;
  }

  .progress {
    background: #0a2040;
    border: 1px solid #1a3060;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #8899aa;
  }

  #accounts-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
  }

  #accounts-list li {
    margin: 0.5rem 0;
  }

  #accounts-list a {
    color: #5bc0de;
    text-decoration: underline;
    font-family: monospace;
    font-size: 0.85rem;
    word-break: break-all;
  }

  #accounts-list a:hover {
    color: #7dd4ed;
  }
</style>

<script>
  import { Keypair, Networks } from "@stellar/stellar-sdk";
  import { Client } from "factory";
  import {
    accountUrl,
    loadAccounts,
    savePendingAccount,
  } from "@g2c/passkey-sdk";

  const FACTORY_CONTRACT_ID = "CC6VKNDN5FBTISOR57XXHIY6L7FSL2KBQHDNRWDEQEAD6G7JODMXWYSO";
  const RPC_URL = "https://soroban-testnet.stellar.org";
  const FRIENDBOT_URL = "https://friendbot.stellar.org";

  const $createBtn = document.getElementById("create-btn") as HTMLButtonElement;
  const $progressInfo = document.getElementById("progress-info")!;
  const $passkeySection = document.getElementById("passkey-section")!;
  const $cAddressResult = document.getElementById("c-address-result") as HTMLPreElement;
  const $setupLink = document.getElementById("setup-link") as HTMLAnchorElement;
  const $errorBox = document.getElementById("error-box")!;
  const $accountsSection = document.getElementById("accounts-section")!;
  const $accountsList = document.getElementById("accounts-list")!;

  function showError(msg: string) {
    $errorBox.textContent = msg;
    $errorBox.style.display = "block";
  }

  function clearError() {
    $errorBox.style.display = "none";
  }

  // --- Show active accounts ---

  const activeAccounts = loadAccounts();
  if (activeAccounts.length > 0) {
    $accountsSection.classList.remove("hidden");
    for (const cAddress of activeAccounts) {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.href = accountUrl(window.location.host, cAddress, "/account/");
      a.textContent = cAddress;
      li.appendChild(a);
      $accountsList.appendChild(li);
    }
  }

  // --- Create new account ---

  $createBtn.addEventListener("click", async () => {
    clearError();
    $createBtn.disabled = true;
    $createBtn.textContent = "Creating...";

    try {
      $progressInfo.style.display = "block";
      $progressInfo.textContent = "Generating account...";

      const keypair = Keypair.random();
      const publicKey = keypair.publicKey();
      const secret = keypair.secret();

      $progressInfo.textContent = "Funding account on testnet...";
      const res = await fetch(`${FRIENDBOT_URL}?addr=${publicKey}`);
      if (!res.ok) throw new Error(`Funding failed: ${res.status}`);

      $progressInfo.textContent = "Predicting smart account address...";
      const client = new Client({
        contractId: FACTORY_CONTRACT_ID,
        networkPassphrase: Networks.TESTNET,
        rpcUrl: RPC_URL,
        publicKey: publicKey,
      });

      const tx = await client.get_c_address({ funder: publicKey });
      const cAddress = tx.result;

      // Save as pending
      savePendingAccount(cAddress, secret);

      $progressInfo.style.display = "none";
      $cAddressResult.textContent = cAddress;
      $setupLink.href = accountUrl(window.location.host, cAddress, `/new-account/?key=${secret}`);
      $passkeySection.classList.remove("hidden");

      $createBtn.textContent = "Create Account";
      $createBtn.disabled = false;
    } catch (err: any) {
      showError(err.message || String(err));
      $progressInfo.style.display = "none";
      $createBtn.textContent = "Create Account";
      $createBtn.disabled = false;
    }
  });
</script>
